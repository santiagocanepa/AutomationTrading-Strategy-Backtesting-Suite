![image](https://github.com/user-attachments/assets/7dcef661-932b-4e2b-8529-2f0a2d3e16c0)

# Combination Generation and Analysis for Backtesting

This directory contains all the Python scripts needed to generate strategy combinations, prepare populations for backtesting, and analyze the results obtained. Each of the files and their function within the process is detailed in detail below.


### Directory Structure

```plaintext
Generate Combination Python/
├── envnew/
├── GenerateCombination.ipynb
├─── AddQuotesJSONFinal.py
├─── TotalCombinationToPoblation.py
├─── CompareResultsFinalCsvwithJsonTotalCombination.py
├── CheckJsonDuplicatesinDirectories.py
├── CheckJsonComplete200.py
├── ResultsPoblationToCsvTotalResults.py
├─── ReturnFromCSVaJsontheNoResults.py
├─── requirements.txt.
```

### Prerequisites.

- **Python 3.x** installed on the system.
- **Jupyter Notebook** to run `.ipynb` files.
- Python libraries specified in `requirements.txt`.
- Basic knowledge of Python and JSON handling.

### Generation of Combinations

- **1. GenerateCombination.ipynb**

  - This Jupyter Notebook is the starting point for generating all possible combinations of strategies based on the desired parameters.
  
  - **Description**
  
    - It allows to generate combinations of indicators and parameters according to the user's preferences.
  
  - **How to use it**
  
    1. Open the `GenerateCombination.ipynb` file with Jupyter Notebook.
    2. Configure the parameters and variables according to your needs.
    3. Run all cells to generate the `TotalCombinations.json` file.
  
  - **Notes**.
    
    - It is recommended to refer to the notebook link in Kaggle for a detailed example of how the combinations were generated.
    - Make sure the input data and settings are correct before executing.
      
    - [KaggleGenerateCombination](https://www.kaggle.com/code/ivancanepa/generate-combinations)

- **2. AddComillasJSONFinal.py**

  - This script adds the necessary quotes to the JSON file generated by the above notebook to ensure correct interpretation by the Puppeteer script.
  
  - **Description**
  
    - Corrects the JSON syntax to make it compatible with the automated backtesting process.
  
  - **Use**
  
    - Run the script from the command line:
  
      ```
      
      python AddComillasJSONFinal.py TotalCombinations.json CombinationsFormatted.json
      
      ```
      
    - `TotalCombinations.json`: JSON file generated by the notebook.
    - `CombinationsFormatted.json`: Name of the output file with the corrections applied.


  - **Notes**

    - This step is crucial to avoid errors during backtesting. Verify that the output file is correctly formatted.
   
  ### Preparation of Populations for Backtesting

- **3. TotalCombinationToPoblation.py**

  - This script splits the total combinations file into multiple JSON files, each containing 200 combinations. This facilitates management and processing during backtesting, allowing restarting from an intermediate point in case of failures.

  - **Description**

      - Generates populations of 200 combinations each. Lists the combinations from 1 to 200 in each file for easy tracking. Assigns each combination a unique identifier under the “name” key.

  - **Use**

    - Modify the line in the script to properly name the output files:

      ```python
      output_file = os.path.join(output_dir, f “population[AssetName]{file_index + 1}.json”)
      ```

    Replace `[AssetName]` with the desired name to identify the asset or strategy. Run the script from the command line:

      ```bash
      python TotalCombinationToPoblation.py CombinationsFormatted.json Populations
      ```
  
  - `CombinationsFormatted.json`: JSON file formatted by AddQuotesJSONFinal.py.
  - `Poblaciones`: Folder where the population files will be saved.

  - **Notes**.
  
    - Make sure that the output folder exists or that the script has permissions to create it. The generated files should be copied to the root of the Puppeteer project for backtesting.

### Post-Processing and Analysis of Results

- **4. CompareResultsFinalCsvwithJsonTotalCombination.py**

    - This script compares the files in the results folder with those in the Populations (Poblaciones) folder to identify if any files are missing or if there are additional files that do not match.

    - **Description**

        - Ensures that all results files match their respective populations and that there are no inconsistencies.

    - **Use**

        - Run the script from the command line:

            ```bash
            python CompararResultsFinalCsvconJsonTotalCombination.py
            ```

        - Make sure that the results and Populations folders are in the correct directory.

    - **Notes**

        - Useful for verifying the completeness of the backtesting process. Generates a report indicating missing or excess files.
     
- **5. CheckJsonDuplicatesInDirectories.py**

    - When using multiple scripts or accounts in parallel, this script helps to check for duplicate JSON files in the specified directories.

    - **Description**

        - Avoids conflicts and redundancies by ensuring that each combination is processed only once.

    - **Use**

        - Run the script by specifying the directories to check:

            ```bash
            python RevisarJsonDuplicadosenDirectorios.py directory1 directory2
            ```

        - `directory1`, `directory2`: Paths of the directories to compare.

    - **Notes**

        - Ideal for environments where processing load is distributed. Ensures the integrity of data and results.
     
- **6. Verifyjsoncompletes200.py**

    - This script verifies that each JSON file in the populations contains exactly 200 combinations.

    - **Description**

        - Ensures consistency of the population files before backtesting.

    - **Use**

        - Run the script in the folder containing the populations:

            ```bash
            python Verificarjsoncompletos200.py
            ```
    - **Notes**

        - If any file does not have all 200 combinations, the script will report what they are for correction.
     
### Advanced Analysis in Jupyter Notebook

[Enlace de Jupyter](https://www.kaggle.com/code/ivancanepa/analysis-of-indicators-in-results/)

- Once the backtesting results have been obtained and the CSV files have been generated, you can proceed to a deeper analysis using Jupyter Notebook.

- **Objective**

  - Identify the best combinations. Measure the effectiveness of each indicator and adjust risk management parameters.

- **Methodology**

  - Use net profit as the main metric. Although this is not usually relevant, and what matters most is the profit factor and the number of trades made, in this particular case, given that all strategies were tested with the same initial capital, the Net Profit variable synthesizes well the combination of these two. Analyze the effectiveness of each indicator when it appears in optional mode, in order to isolate its impact. Introduce the entropy of each combination to consider the interdependence between indicators.

  - ![image](https://github.com/user-attachments/assets/57577ab5-040c-4f06-8053-88619af3302c)

- **Steps**

    1. Open a new Jupyter Notebook.
    2. Import the generated CSV:

        ```python
        import pandas as pd
        df = pd.read_csv('resultados_totales.csv')
        ```

    3. Segment the DataFrame according to indicators, risk management and results.
    4. Perform statistical analysis and visualizations to extract insights.
 
- **Notes**

    - The “name” column is essential to identify and track each combination. Consider using multivariate analysis techniques to better understand the interactions between variables.

### Environment Requirements

- To ensure proper operation of all scripts, be sure to install the libraries specified in requirements.txt.

- **Libraries Installation**

    ```bash
    pip install -r requirements.txt
    ```


### Additional Notes

- **Folder Organization**

    - Maintain an orderly structure of the Populations, results, and any other folders used in the process. This makes it easier to locate files and avoids confusion during processing.

- **Backups**.

    - Make periodic backups of JSON and CSV files to prevent data loss.

- **Error Handling**

    - Watch for possible errors during script execution and check logs or error messages to fix them.

- **Optimization**

  - In case your knowledge of introducing human bias is limited, I recommend using my jupyter configuration for risk management and optional indicator ranges enabled, modifying only the indicators you wish to combine in both optional and excludable status. Considering all the parameters configurable and manipulable by the puppetier script, the total space of combinations is 1.4 billion. If you have the knowledge to introduce human bias you can adjust the space creation to process more combinations per file if your environment allows it (using multiple accounts), but keep in mind that very large files can be difficult to handle, the puppetier script is optimized as much as possible to interact with the interface and is able to perform 6 backtestings per minute. In case of generating a dataset with more than 50 thousand combinations it would be ideal to use a genetic/evolutionary model, but one must take into account the considerable interdependence between the indicators and the possibility that these models get stuck for a long time in local optima.
 
# Contact us

For questions or suggestions related to these scripts, you can contact us through:

- **Email**: `canepasantiago.ivan@gmail.com`
